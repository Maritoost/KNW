from flask import Flask, render_template_string, jsonify
from openpyxl import load_workbook
import requests
from io import BytesIO

app = Flask(__name__)

EXCEL_URL = 'https://raw.githubusercontent.com/Maritoost/KNW/main/Split_KennisNetwerk_Projects_version4.xlsx'

def get_excel_data():
    response = requests.get(EXCEL_URL)
    workbook = load_workbook(filename=BytesIO(response.content))
    sheet = workbook.active
    projects = {
        'Droogte': [],
        'Waterkwaliteit': [],
        'Wateroverlast': []
    }
    for row in sheet.iter_rows(min_row=2, values_only=True):
        project = {
            'ID': row[0],
            'FocusArea': row[1],
            'ProjectName': row[2],
            'Hoofduitvoerder': row[3],
            'Samenvatting': row[4],
            'Bereik': row[5],
            'Financieringsbron': row[6],
            'Organisatietype': row[7],
            'Samenwerkingspartners': row[8],
            'Gebruiker': row[9],
            'Website': row[10]
        }
        projects[project['FocusArea']].append(project)
    return projects

projects_data = get_excel_data()

@app.route('/')
def index():
    return render_template_string(template, projects=projects_data)

template = '''
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kennisnetwerk Water</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .bubble { width: 200px; height: 200px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; cursor: pointer; margin: 10px; }
        #droogte { background-color: #ff6347; }
        #waterkwaliteit { background-color: #6ab150; }
        #wateroverlast { background-color: #4682b4; }
        .hidden { display: none; }
        footer { font-style: italic; font-size: 12px; text-align: center; margin-top: 20px; }
        .project { margin: 10px 0; }
        .details { display: none; margin-left: 20px; font-size: 1em; }
        .project-name { font-size: 1em; font-style: italic; cursor: pointer; color: black; text-decoration: underline; }
    </style>
    <script>
        let lastOpen = null;
        function toggleDetails(projectId) {
            const details = document.getElementById(`details-${projectId}`);
            if (lastOpen && lastOpen !== details) {
                lastOpen.style.display = 'none';
            }
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
            lastOpen = details.style.display === 'none' ? null : details;
        }
        let lastVisible = null;
        function toggleVisibility(focusArea) {
            const element = document.getElementById(focusArea + "-projects");
            if (lastVisible && lastVisible !== element) {
                lastVisible.classList.add('hidden');
            }
            element.classList.toggle('hidden');
            lastVisible = element.classList.contains('hidden') ? null : element;
        }
    </script>
</head>
<body>
    <h1>Kennisnetwerk Water</h1>
    <p style="font-size: 24px; font-weight: bold;">Focusgebieden:</p>
    <div class="bubble" id="droogte" onclick="toggleVisibility('droogte')">Droogte</div>
    <div class="bubble" id="waterkwaliteit" onclick="toggleVisibility('waterkwaliteit')">Waterkwaliteit</div>
    <div class="bubble" id="wateroverlast" onclick="toggleVisibility('wateroverlast')">Wateroverlast</div>

    {% for focus_area, projects in projects.items() %}
    <div id='{{ focus_area.lower() }}-projects' class='hidden'>
        <ul>
            {% for project in projects %}
            <li><span class='project-name' onclick="toggleDetails('{{ project['ID'] }}')">{{ project['ProjectName'] }}</span>
                <div id="details-{{ project['ID'] }}" class="details">
                    <p><strong>Hoofduitvoerder:</strong> {{ project['Hoofduitvoerder'] }}</p>
                    <p><strong>Samenvatting:</strong> {{ project['Samenvatting'] }}</p>
                    <p><strong>Bereik:</strong> {{ project['Bereik'] }}</p>
                    <p><strong>Financieringsbron:</strong> {{ project['Financieringsbron'] }}</p>
                    <p><strong>Organisatietype:</strong> {{ project['Organisatietype'] }}</p>
                    <p><strong>Samenwerkingspartners:</strong> {{ project['Samenwerkingspartners'] }}</p>
                    <p><strong>Gebruiker:</strong> {{ project['Gebruiker'] }}</p>
                    <p><strong>Website:</strong> <a href="{{ project['Website'] }}" target="_blank">{{ project['Website'] }}</a></p>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}

    <footer>
        <p>Â© Kennisnetwerk Water Projecten</p>
    </footer>
</body>
</html>
'''

if __name__ == '__main__':
    app.run(debug=True)
